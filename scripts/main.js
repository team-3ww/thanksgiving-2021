const metadata = {
  "designed-in-year-of-the-ox": {
    id: "1",
    hash: "2c4ca1ee45b6d2e9a5eda1fe496761db9169ad182dc9e9db0ca83e6731564009",
    clues: {
      b80394dec5bb5e59e44684975b352d4efa10482b13354af17ea36890bc5cee20:
        "[submission] is a clue for this puzzle.",
    },
  },
  friends: {
    id: "2",
    hash: "1934821bc9049706c500ddd598232d180805735cce701b927953d97f06065eac",
    note: "U2FsdGVkX19eKNYyVzeLnGbSGvdGy9YC946/fHnGJPlZ6P+/MG90k7Iqjq/7job1wgU/I+MYmNzlevnSClNxgaRGEYHdmaTT2kr2rWYSRCN79fBcsuKsW35/DcTGQh4nWV7gAE5VBiuDuZJGZJ4NXUmDmJr/97f4wj1Qp1Gr+fm93rhe7JjTTjBJXcgp5KWAS0+ovR6yX+mysIRlzPe3wuCIGWkiZRrzvgHmgPO0xZuUBsu5iTK1RYaZeH6aESRV1rEBRWQ5c0M9nQUoioCQsDXopLQV8TCGFHRIBw4NGk3Huu3/RiUYVolLt/gf7zHnbVSfNSCqHGC+vlaOlV2MCUnv2FUDk0QyHYR9G8jT7T52DrRwf3mJEORjh0NorJcRcZN8V02gBKbhBBw/xD/YlayTBWUAahTmLpOE0uiyDk3GY06DXO+9SOk0+FRdxxcn9cPxkDe00I0gxqNwKqIfXTgL9ZyqSL7O2RijuqxNn7x3PyjF7rVanLcdJa21qVYN/h+hjKqK6Tn1l0k0e0+SAA==",
  },
  "journey-to-the-past": {
    id: "3",
    hash: "27265a5e5273291919ace0e1eabf37924b688bc66d9b6cc1d15c89c0e8851306",
    clues: {
      d2124868a41eb3dc58810833420f5d3e47a39a6dc0546093e88f9cd276c37e72:
        "[submission] is a clue for this puzzle.",
    },
  },
  "kangs-cross": {
    id: "4",
    hash: "88e8d40596541cb4315fbec31ac21d8244a983815668063d27747c0078fcf92d",
    message:
      "U2FsdGVkX19Wm3RXr3LdPqXodSYK7m6D7gNFtmaT/UxgStVTWcVCA22MvvOwVsfcGkdUKFycX7OCu32J9yzdPY58EDgBmPGRzDhgeAxOcKgBFzmYfgKX+zFkaBmyknGMeR4Nj+j0VRIdgYwjHOc7ITwSjvoZItH48xxiJqaozWy7cL9Nedl5OFcWXukn7Vg4",
  },
  "novel-but-socially-inept": {
    id: "5",
    hash: "ee8667f9999dd6f5daa148bbf4b6ca08eb0a59b09465540a19ec8c54d7ec949f",
    note: "U2FsdGVkX1+fn4k5sbnq3lJDuCDfmn+PSE+PhaFevqJYsZzzuxh9r5lx8reRdsmGVwW3kBxScrtmftluj0btPmJOi117kQ6EVeuqyQS2f4ejy9h1F0YAaBDxcoA+5OWVZqtD/ifIgdWcHAGfRjWSenFayPsjcEaQXzmN7a2mz419IdOFRrU4ebGzZarZRqHCWxVsXhI3f8uzgNM72YO5wtdHjw/X5drftvVlY5JE1b3oe89I1uy4L+K+WuHvZDg3sq2ZRlKROTu4lwpvuBNHCWYzolSQWkSKZEurml++VxomNjks0Rbyy6c9+2TgBP0sylNHRB8awXwqWCJ9v2SKH6bFaRUfUWKBseYEcemrMSff7pdq4pyMd2Vt21+pzimr/BHtHeSBEnhtD4hkpVYyMc1MB0xKU3okKO26QIc3TuI=",
  },
  "three-bes": {
    id: "5-a",
    hash: "ee8667f9999dd6f5daa148bbf4b6ca08eb0a59b09465540a19ec8c54d7ec949f",
  },
  "tournament-of-the-champions": {
    id: "6",
    hash: "5fc1da5f0ab904233b9f2dceac067d7a69a1138e9f7dc4053773647453f3b7bd",
  },
  "three-kings-of-the-age": {
    id: "6-a",
    hash: "5fc1da5f0ab904233b9f2dceac067d7a69a1138e9f7dc4053773647453f3b7bd",
    note: "U2FsdGVkX19kOHXPxU6Ju3rMhh3cxOW0EzUWt3IMV5Poz0AxPc7irL1u+wVU6dHw7jiwH+4AaYl2UNqoN6xMsZfdBtC7rNLOqSuu1dlmCfmHUzUezOOIGoyZ+clBLWmzxsKVlTKfRdlkwzatrUNWLZEqrZmWXNd7A9UPC6cSA40wOJavrn38iRHUS2wW92G3Dy5fs2BUGk8qvolFX7TZfZ2+517XQAhlknd+gvHooNqgmoc31vYJX1jAmMM0KI1g",
  },
  "ultimate-association-game": {
    id: "7",
    hash: "120a2ee6af158090a1da82b3cc8865d79b3d575e49a9bfafc12d049c7b3fe835",
    note: "U2FsdGVkX1+g6ixjvQ/lXKtB5OiucNO9xouAmTS4aLt0KEW6KIr3ahSSt0cgtUJzkBOAPg9pW4OodtbCADBO1ZO3QDX04P4SRSDUZunDUEHOc/XqAmgjRYmbBcatpuEeoYABuxauiArxlSITGwvIoKBmDloPfcWsk6RzWs1octyB3O78f4SL99BZOZ6h/Wlq89BJFKewlF3WLir7NPGBmqlPG5TfU/mBwWWyGjuJ8Wg=",
  },
  "wizards-game": {
    id: "7-a",
    hash: "120a2ee6af158090a1da82b3cc8865d79b3d575e49a9bfafc12d049c7b3fe835",
  },
  "family-style-feast": {
    id: "meta",
    hash: "4602da3526f459ed0abce389272008003e617ed746592f373037deba7df75ef3",
    message:
      "U2FsdGVkX19COwe5bt3IlgI5Wcc2ce16/+xmS/tFTD3/25BZOnMbJnXed8XuVi2i70A0YJ/jjxWhVckawGoHEcFMSBmm6AYGN25eHzzfXvFBpfadRGmvQ2E3AzKthyU34Lwr+uvp3lNXbRA5x5tFPraq5q+DdJrQFuK1jbTMjpB6vL3aZO52PBw3XxHMX3s2WJNigmQFUl4HLjAUDhk53wJmqtTtuZDgD0idkmgwVvfWf4TVxHK4E5lzth3ZLEq4uymN6PuEFpPXno4PArFEqgSRxD6ZG/s3p7ZCLRS5aP+UPX1O97jKMp22afXTgO3xM09cHhxSJ+bywIF7A82ncon6JYk/MVggu7F/yN55dNBUE6UjXukDXnG3G2EqNRVVInOSjE2ugqh8FLPr8gQP9pzNtMRuhgu15DI7fW9/toDbpBwP813zNC7IuimaDKFHUBYK6XyDg4pZrzkz8epvMg==",
  },
};

$(() => {
  const checkIntro = () => {
    if (Cookies.get("intro") !== "SOLVED") {
      location.href = "intro";
    } else {
      $(".content").show();
    }
  };

  const fetchSolved = () => {
    const pathParts = window.location.pathname.split("/");
    Object.keys(metadata).forEach((puzzSlug) => {
      const puzzData = metadata[puzzSlug];
      const puzzCode = puzzData.id;
      if (Cookies.get(puzzSlug) === "SOLVED") {
        $(`.puzzle.puzzle-${puzzCode}`).addClass("status-solved");
        for (let pathPart of pathParts) {
          if (pathPart === puzzSlug) {
            const solution = Cookies.get(`${puzzSlug}_solution`);
            if (solution) {
              $(".solution").text(solution);
              $(".solved").fadeIn();
              if (puzzData.message) {
                const answerified = solution
                  .toUpperCase()
                  .replace(/[^A-Z]/g, "");
                let message = CryptoJS.AES.decrypt(
                  puzzData.message,
                  answerified
                ).toString(CryptoJS.enc.Utf8);
                $(".solved").click(() => {
                  $("#alert").html(message).modal();
                });
              }
            }
          }
        }
      }
    });
  };

  const checkAnswer = (puzzId) => {
    $("#alert").removeClass("correct incorrect").html("").hide();
    const submission = $("#guess-box").val().trim();
    $("#guess-box").val(submission);
    if (!submission) {
      return;
    }
    $("#guess-box").val("");
    const pathParts = window.location.pathname.split("/");
    for (let pathPart of pathParts) {
      if (Object.keys(metadata).includes(pathPart)) {
        const data = metadata[pathPart];
        const answerified = submission.toUpperCase().replace(/[^A-Z]/g, "");
        const hash = CryptoJS.SHA256(answerified).toString();
        if (hash === data.hash) {
          return handleCorrect(pathPart, submission.toUpperCase());
        }
        if (data.hasOwnProperty("clues")) {
          if (data.clues.hasOwnProperty(hash)) {
            const clue = data.clues[hash].replace(
              "[submission]",
              submission.toUpperCase()
            );
            gtag("event", pathPart, {
              result: "CLUE",
              submission: submission,
            });
            return $("#alert").html(`<p>${clue}</p>`).modal();
          }
        }
        handleIncorrect(pathPart, submission);
      }
    }
  };

  const handleCorrect = (puzzSlug, solution) => {
    const puzzData = metadata[puzzSlug];
    const defaultMessage = `<p><b>${solution}</b> is correct!</p><p><img src=../../assets/turpenguin.png /></p>`;
    let message = defaultMessage;
    const answerified = solution.toUpperCase().replace(/[^A-Z]/g, "");
    if (puzzData.message) {
      message = CryptoJS.AES.decrypt(puzzData.message, answerified).toString(
        CryptoJS.enc.Utf8
      );
    }
    if (puzzData.note) {
      message += `<section class='note'>${CryptoJS.AES.decrypt(
        puzzData.note,
        answerified
      ).toString(CryptoJS.enc.Utf8)}</section>`;
    }
    message += "<p class=subnote>(victory music is not a puzzle)</p>";
    Cookies.set(puzzSlug, "SOLVED");
    Cookies.set(`${puzzSlug}_solution`, solution);
    $("#alert").html(message).addClass("correct").modal();
    fetchSolved();
    gtag("event", puzzSlug, {
      result: "CORRECT",
      submission: solution,
    });
    setTimeout(() => {
      new Audio(
        `../../assets/sounds/${CryptoJS.SHA256(
          puzzSlug + "_" + answerified
        ).toString()}.mp3`
      ).play();
    }, 250);
  };

  const handleIncorrect = (puzzSlug, submission) => {
    $("#alert").html(`<p>Sorry, not correct</p>`).addClass("incorrect").modal();
    gtag("event", puzzSlug, {
      result: "INCORRECT",
      submission: submission,
    });
  };

  $("#submit").click(checkAnswer);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && document.activeElement.id === "guess-box") {
      checkAnswer();
    }
  });

  fetchSolved();
});
